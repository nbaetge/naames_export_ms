---
title: "Processed Export for Diaz et al., 2020"
author: "Nicholas Baetge"
date: "6/22/2020"
output: github_document
---

# Intro

This document is shows how nitrate drawdown and NCP were calculated from the processed bottle file

```{r include=FALSE}
library(tidyverse)
library(readxl)
library(knitr)
library(googledrive)
library(googlesheets4)
library(data.table)  
#for interpolations
library(zoo) 
#for integrations
library(oce) 
library(scales)
library(gridExtra)
#for time
library(lubridate)

custom_theme <- function() {
  theme_test(base_size = 30) %+replace%
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA)) 
}

levels = c("GS/Sargasso", "Subtropical", "Temperate", "Subpolar",  "AT39-6", "AT34", "AT38", "AT32", "Early Spring", "Late Spring", "Early Autumn", "Late Autumn")

custom.colors <- c("AT39" = "#377EB8", "AT34" = "#4DAF4A", "AT38" = "#E41A1C", "AT32" = "#FF7F00", "Temperate" = "#A6CEE3", "Subpolar" = "#377EB8", "Subtropical" = "#FB9A99", "GS/Sargasso" = "#E41A1C", "Early Spring" = "#377EB8", "Late Spring" = "#4DAF4A","Early Autumn" = "#E41A1C", "Summer" = "#E41A1C", "Late Autumn" = "#FF7F00", "Gv2_2019" = "#377EB8", "WOA18_MN" = "#4DAF4A", "WOA18_AN" = "#E41A1C")


```

# Import Data 

```{r}
processed_bf <-  read_rds("~/naames_export_ms/Output/processed_bf.2.2020.rds")

mld_diaz <- read_excel("~/naames_export_ms/Input/MLD_Diaz_6.19.2020.xlsx") %>% 
  mutate(Date = ifelse(NAAMES == 3 & Station == 1, "20170904", Date),
         Date = ifelse(NAAMES == 4 & Station == 3, "20180330", Date)) %>% 
  mutate(Cruise = ifelse(NAAMES == 1, "AT32", NA),
         Cruise = ifelse(NAAMES == 2, "AT34", Cruise),
         Cruise = ifelse(NAAMES == 3, "AT38", Cruise),
         Cruise = ifelse(NAAMES == 4, "AT39-6", Cruise),
         Station = ifelse(Station == "5b", 5, Station),
         Station = ifelse(Station == "1a", 0, Station),
         Date = ymd(Date)) %>% 
  mutate_at(vars(Station), as.numeric) %>% 
  select(-NAAMES) %>% 
  rename(Diaz_MLD = Z_MLD) 

```

# Subset Relevent Data

```{r warning = FALSE}

subset <- processed_bf %>% 
  left_join(., mld_diaz) %>% 
  select(Cruise:N2, Diaz_MLD, everything()) %>% 
  drop_na(Diaz_MLD) %>% 
  #omitting CampCN 98 because only measurements at 5 m and below 1500 m were taken. the interpolated values for this cast were as a result, not reliable
  filter(!CampCN == 98) %>% 
  #the multiday N2S4 drifted from the 48˚Lat bin to the 47˚Lat bin, but was a lagrangian study (followed float), so we'll denote all casts within station 4 as being in the 48˚N bin. This also occured with N1S7 - casts will be in the 40˚ bin with a max MLD of 484 m
  mutate(degree_bin = ifelse(Cruise == "AT34" & Station == "4", 48, degree_bin),
         degree_bin = ifelse(Cruise == "AT32" & Station == "7", 40, degree_bin),
         Max_MLD = ifelse(Cruise == "AT34" & Station == "4", 508, Max_MLD),
          Max_MLD = ifelse(Cruise == "AT32" & Station == "7", 484, Max_MLD),) %>% 
  select(Cruise, Latitude, Longitude, Date, degree_bin, Station, Season, Subregion,  CampCN, Max_MLD,  Diaz_MLD, Target_Z,  interp_DOC) %>% 
  distinct() %>% 
  drop_na(interp_DOC)
  
```

# Interpolate Depth of MLD

We'll interpolate variables to the depth of the euphotic zone for each cast separately

```{r warning = FALSE, message = FALSE}
#split the df by CampCN  
add_mld.list <- split(subset, subset$CampCN)

#create a function to add an empty row to each cast, then add the max MLD to the Target Z column 
add.func <- function(morty){
  morty[nrow(morty) + 1,] <- NA
  morty$Target_Z[is.na(morty$Target_Z)] <- morty$Diaz_MLD
  rick <- morty %>% 
    fill(., Cruise:Diaz_MLD, .direction = c("updown")) %>% 
    arrange(CampCN, Target_Z)
  
  }

#apply function to list 
added_mld.list <- lapply(add_mld.list, add.func)


#save the list as a data frame 
added_mld.df <- plyr::ldply(added_mld.list, data.frame) %>% 
  group_by(CampCN) %>% 
  distinct(., Target_Z, .keep_all = T) %>% 
  select(-.id) %>% 
  ungroup() %>% 
  filter(!Target_Z == "-Inf")


#split the data frame into lists based on the campaign cast number
to_interpolate.list <- split(added_mld.df, added_mld.df$CampCN)

#create a function that will linearly interpolate each VOI according to the depth intervals of the casts 
interpolate.func <- function(copper) {
to_interpolate.df <- copper %>% 
  select(Target_Z:ncol(.)) %>% 
  zoo(., order.by = .$Target_Z) 

interp_doc <- as.numeric(na.approx(to_interpolate.df$interp_DOC, na.rm = F))
Target_Z <- to_interpolate.df$Target_Z
interpolations.df <- data.frame(Target_Z, interp_doc)
}

#apply function to list 
interpolations.list <- lapply(to_interpolate.list, interpolate.func)

#save the list as a data frame 
interpolations.df <- plyr::ldply(interpolations.list, data.frame) %>% 
  rename(., CampCN = .id) 

#combine the interpolated and non-interpolated data frames
interpolations.df$CampCN <- as.numeric(interpolations.df$CampCN)
interpolated.df <- right_join(subset, interpolations.df) %>% 
  select(Cruise:Diaz_MLD,  Target_Z, interp_doc) %>% 
  group_by(CampCN) %>% 
  fill(Cruise:Subregion, Max_MLD:Diaz_MLD, .direction = "updown") %>% 
  ungroup()

```

## Average Variable Values

We'll use these averages to redistribute profiles

```{r}
to_redis <- interpolated.df %>%
  group_by(Cruise, Station, Target_Z) %>% 
  mutate(ave_DOC = mean(interp_doc, na.rm = T),
         ave_DOC = ifelse(ave_DOC == "Nan", NA, ave_DOC),
         sd_DOC = sd(interp_doc, na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave_lat = round(mean(Latitude, na.rm = T), 2),
         ave_lon = round(mean(Longitude, na.rm = T), 2),
         ave_date = mean(Date)) %>% 
  select(-contains("Ez")) %>% 
  select(Cruise, ave_lat, ave_lon, ave_date, degree_bin:Subregion, Max_MLD, Target_Z, ave_DOC, sd_DOC) %>%
  distinct() %>% 
  arrange(Cruise, Station, Target_Z) %>% 
  ungroup()

```


# Redistribute DOC Profiles

```{r}
redis_DOC <- to_redis %>% 
  drop_na(ave_DOC) %>% 
  group_by(Cruise, Station) %>% 
  filter(Target_Z <= Max_MLD) %>% 
  mutate(redis_DOC_vol = integrateTrapezoid(Target_Z, ave_DOC, type = "A")/Max_MLD) %>% 
  select(Cruise, Station,  degree_bin, redis_DOC_vol) %>% 
  distinct() %>% 
  ungroup() %>% 
  group_by(degree_bin) %>% 
  arrange(degree_bin) %>% 
  mutate(redis_DOC_vol = ifelse(Cruise %in% c( "AT34", "AT39-6") & degree_bin %in% c(44), NA, redis_DOC_vol),
         ave_redis_DOC = mean(redis_DOC_vol, na.rm = T),
         redis_DOC_vol = ifelse(is.na(redis_DOC_vol) & degree_bin == 44, ave_redis_DOC, redis_DOC_vol)) %>% 
  select(-c(ave_redis_DOC)) %>% 
  fill(redis_DOC_vol, .direction = "updown") %>% 
  ungroup() %>% 
  arrange(Cruise, Station)
```

# Calculate Mixed Profile Areas in Diaz_MLD

```{r message = FALSE}
redis_areas <- interpolated.df %>% 
  left_join(., redis_DOC) %>% 
  mutate(redis_DOC_diaz_mld_area = redis_DOC_vol * Diaz_MLD ) %>% 
  drop_na(interp_doc) 

  
```


# Integrate DOC Profiles 

```{r message = F}
int_DOC <- redis_areas %>% 
  group_by(Cruise, Station, CampCN) %>% 
  filter(Target_Z <= Max_MLD) %>%
  mutate(int_DOC_maxmld = integrateTrapezoid(Target_Z, interp_doc,type = "A")) %>% 
  filter(Target_Z <= Diaz_MLD) %>%
  mutate(int_DOC_diaz_mld = integrateTrapezoid(Target_Z, interp_doc,type = "A")) %>% 
  ungroup() %>% 
  select(Cruise, Station, Date, CampCN, int_DOC_diaz_mld) %>% 
  distinct() 
```


# Calculate  ∆DOC in Diaz_MLD


```{r message = FALSE}
processed_export <- redis_areas %>% 
  left_join(., int_DOC) %>% 
  group_by(Cruise, Station, CampCN ) %>% 
  mutate(int_delta_DOC_diaz_mld = (int_DOC_diaz_mld - redis_DOC_diaz_mld_area)/1000,
         vol_delta_DOC_diaz_mld = (int_delta_DOC_diaz_mld/Diaz_MLD) * 1000 ) %>% 
  ungroup() %>% 
  distinct() %>% 
  select(Cruise:Diaz_MLD, int_delta_DOC_diaz_mld, vol_delta_DOC_diaz_mld) %>% 
  distinct() %>% 
  rename(accm_doc_area = int_delta_DOC_diaz_mld,
         accm_doc_vol = vol_delta_DOC_diaz_mld)

processed_export[ is.na(processed_export) ] <- NA

```
 
# Save Data

```{r}
write_csv(processed_export, "~/naames_export_ms/Output/processed_export_for_Diaz.6.22.20.csv")
```

 